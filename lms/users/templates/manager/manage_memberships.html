{% extends 'base.html' %}
{% load membership_extras %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Membership Management</h1>
        <p class="text-gray-600">Manage user memberships and membership types</p>
    </div>

    <!-- Messages -->
    {% if messages %}
        <div class="mb-6">
            {% for message in messages %}
                <div class="p-4 rounded-md mb-2 {% if message.tags == 'success' %}bg-green-50 text-green-800 border border-green-200{% elif message.tags == 'error' %}bg-red-50 text-red-800 border border-red-200{% elif message.tags == 'warning' %}bg-yellow-50 text-yellow-800 border border-yellow-200{% else %}bg-blue-50 text-blue-800 border border-blue-200{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- CSS-only Tab Navigation -->
    <style>
        .tab-content { display: none; }
    </style>



    <!-- Tab Navigation -->
    <div class="mb-6">
        <nav class="flex space-x-8" aria-label="Tabs">
            <a href="?tab=users{% if search_query %}&search={{ search_query }}{% endif %}{% if membership_filter %}&membership={{ membership_filter }}{% endif %}" 
               id="users-tab" class="tab-button border-b-2 py-2 px-1 text-sm font-medium transition-colors {% if active_tab == 'users' %}border-blue-500 text-blue-600{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %}">
                User Memberships
            </a>
            <a href="?tab=types" 
               id="types-tab" class="tab-button border-b-2 py-2 px-1 text-sm font-medium transition-colors {% if active_tab == 'types' %}border-blue-500 text-blue-600{% else %}border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300{% endif %}">
                Membership Types
            </a>
        </nav>
    </div>

    <div class="tabs-wrapper">
        <!-- Tab 1: User Memberships -->
        <div id="users-content" class="tab-content" {% if active_tab == 'users' %}style="display: block;"{% endif %}>
            <!-- Statistics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Total Users with Membership -->
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-green-500">
                    <div class="flex items-center">
                        <div class="flex-1">
                            <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wide">With Membership</h3>
                            <p class="text-3xl font-bold text-gray-900">{{ total_users_with_membership|default:"0" }}</p>
                        </div>
                        <div class="flex-shrink-0">
                            <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Total Users without Membership -->
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-red-500">
                    <div class="flex items-center">
                        <div class="flex-1">
                            <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wide">Without Membership</h3>
                            <p class="text-3xl font-bold text-gray-900">{{ total_users_without_membership|default:"0" }}</p>
                        </div>
                        <div class="flex-shrink-0">
                            <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Total Membership Types -->
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-500">
                    <div class="flex items-center">
                        <div class="flex-1">
                            <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wide">Total Types</h3>
                            <p class="text-3xl font-bold text-gray-900">{{ total_membership_types|default:"0" }}</p>
                        </div>
                        <div class="flex-shrink-0">
                            <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- Most Popular Membership -->
                <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-purple-500">
                    <div class="flex items-center">
                        <div class="flex-1">
                            <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wide">Most Popular</h3>
                            <p class="text-lg font-bold text-gray-900">
                                {% if most_popular_membership %}
                                    {{ most_popular_membership.0 }} ({{ most_popular_membership.1 }})
                                {% else %}
                                    None
                                {% endif %}
                            </p>
                        </div>
                        <div class="flex-shrink-0">
                            <svg class="w-8 h-8 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search and Filter Controls -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <form method="GET" class="flex flex-wrap items-end gap-4">
                    <input type="hidden" name="tab" value="users">
                    
                    <!-- Search Input -->
                    <div class="flex-1 min-w-[200px]">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Search Users</label>
                        <input type="text" name="search" value="{{ search_query }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50"
                               placeholder="Username, name, or email">
                    </div>

                    <!-- Membership Filter -->
                    <div class="flex-1 min-w-[200px]">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Membership Filter</label>
                        <select name="membership" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50">
                            <option value="">All Users</option>
                            <option value="no_membership" {% if membership_filter == 'no_membership' %}selected{% endif %}>No Membership</option>
                            {% for membership_type in membership_types %}
                                <option value="{{ membership_type.id }}" {% if membership_filter == membership_type.id|stringformat:'s' %}selected{% endif %}>
                                    {{ membership_type.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Search Button -->
                    <div>
                        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-md text-sm font-medium transition duration-200">
                            Filter
                        </button>
                    </div>

                    <!-- Clear Button -->
                    <div>
                        <a href="?tab=users" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-md text-sm font-medium transition duration-200 inline-block">
                            Clear
                        </a>
                    </div>
                </form>
            </div>

            <!-- Users Table -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Membership</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assign Membership</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for user in users %}
                            <tr class="hover:bg-gray-50">
                                <!-- User Info -->
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-10 w-10">
                                            <div class="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
                                                <span class="text-sm font-medium text-gray-700">
                                                    {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-gray-900">
                                                {{ user.get_full_name|default:user.username }}
                                            </div>
                                            <div class="text-sm text-gray-500">{{ user.email }}</div>
                                            <div class="text-xs text-gray-400">@{{ user.username }}</div>
                                        </div>
                                    </div>
                                </td>

                                <!-- Role -->
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full 
                                        {% if user.role == 'member' %}bg-blue-100 text-blue-800
                                        {% elif user.role == 'librarian' %}bg-green-100 text-green-800
                                        {% elif user.role == 'manager' %}bg-purple-100 text-purple-800
                                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                                        {{ user.get_role_display }}
                                    </span>
                                </td>

                                <!-- Current Membership -->
                                <td class="px-6 py-4 whitespace-nowrap">
                                    {% if user.membership %}
                                        <div class="text-sm font-medium text-gray-900">{{ user.membership.name }}</div>
                                        <div class="text-xs text-gray-500">
                                            Monthly: MVR {{ user.membership.monthly_fee }} | Annual: MVR {{ user.membership.annual_fee }}
                                        </div>
                                        <div class="text-xs text-gray-500">
                                            Books: {{ user.membership.max_books }} | Loan: {{ user.membership.loan_period_days }}d
                                        </div>
                                    {% else %}
                                        <span class="text-sm text-gray-500 italic">No membership</span>
                                    {% endif %}
                                </td>

                                <!-- Assign Membership -->
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <form method="POST" action="{% url 'users:update_membership' %}" class="inline">
                                        {% csrf_token %}
                                        <input type="hidden" name="user_id" value="{{ user.id }}">
                                        <select name="membership_id" class="text-sm border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                onchange="this.form.submit()">
                                            <option value="">Select Membership</option>
                                            <option value="none" {% if not user.membership %}selected{% endif %}>Remove Membership</option>
                                            {% for membership_type in membership_types %}
                                                <option value="{{ membership_type.id }}" 
                                                    {% if user.membership and user.membership.id == membership_type.id %}selected{% endif %}>
                                                    {{ membership_type.name }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </form>
                                </td>

                                <!-- Action -->
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    <a href="{% url 'users:edit_user' user.id %}" 
                                       class="text-blue-600 hover:text-blue-900 text-sm font-medium">
                                        Edit User
                                    </a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                                    <div class="text-lg font-medium">No users found</div>
                                    <div class="text-sm">Try adjusting your search or filter criteria</div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab 2: Membership Types -->
        <div id="types-content" class="tab-content" {% if active_tab == 'types' %}style="display: block;"{% endif %}>
            <!-- Create New Membership Type Form -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Create New Membership Type</h2>
                <form method="POST" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="create">
                    
                    {% for field in create_form %}
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ field.errors.0 }}</p>
                            {% endif %}
                        </div>
                    {% endfor %}

                    <!-- Submit Button -->
                    <div class="md:col-span-2 lg:col-span-3">
                        <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-md text-sm font-medium transition duration-200">
                            Create Membership Type
                        </button>
                    </div>
                </form>
            </div>

            <!-- Edit Form (if editing) -->
            {% if edit_form %}
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg shadow-md p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-900">Edit Membership Type: {{ edit_membership.name }}</h2>
                    <a href="?tab=types" class="text-gray-600 hover:text-gray-800">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </a>
                </div>
                <form method="POST" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="edit">
                    
                    {% for field in edit_form %}
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}
                                <p class="text-red-500 text-sm mt-1">{{ field.errors.0 }}</p>
                            {% endif %}
                        </div>
                    {% endfor %}

                    <!-- Submit Buttons -->
                    <div class="md:col-span-2 lg:col-span-3 flex space-x-3">
                        <button type="submit" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-md text-sm font-medium transition duration-200">
                            Update Membership Type
                        </button>
                        <a href="?tab=types" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-md text-sm font-medium transition duration-200 inline-block">
                            Cancel
                        </a>
                    </div>
                </form>
            </div>
            {% endif %}

            <!-- Existing Membership Types -->
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-xl font-bold text-gray-900">Existing Membership Types</h2>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monthly Fee</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Annual Fee</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Max Books</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Loan Period</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Extension</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Users</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            {% for membership_type in membership_types %}
                            <tr class="hover:bg-gray-50 {% if edit_membership and edit_membership.id == membership_type.id %}bg-yellow-50{% endif %}">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900">{{ membership_type.name }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">MVR {{ membership_type.monthly_fee }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">MVR {{ membership_type.annual_fee }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">{{ membership_type.max_books }}</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">{{ membership_type.loan_period_days }} days</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">{{ membership_type.extension_days }} days</div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900">
                                        {% with membership_distribution|get_item:membership_type.name as user_count %}
                                            {{ user_count|default:"0" }}
                                        {% endwith %}
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                    <a href="?tab=types&edit={{ membership_type.id }}" 
                                       class="text-blue-600 hover:text-blue-900">Edit</a>
                                    
                                    <form method="POST" action="{% url 'users:delete_membership_type' membership_type.id %}" class="inline" 
                                          onsubmit="return confirm('Are you sure you want to delete this membership type?')">
                                        {% csrf_token %}
                                        <button type="submit" class="text-red-600 hover:text-red-900">Delete</button>
                                    </form>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="8" class="px-6 py-8 text-center text-gray-500">
                                    <div class="text-lg font-medium">No membership types found</div>
                                    <div class="text-sm">Create your first membership type above</div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}